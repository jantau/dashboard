library(tidyverse)

#----------------------------------------------------------------------------------------
# load results
#----------------------------------------------------------------------------------------

#load new publication dataset
publications_old <- read_rds("./results/Charite_publication_table.rds")
publications <- read_csv("./main/publication_table_library_280421.csv")

#results files
results_folder <- "results/"
results_files <- list.files(results_folder)
results_files <- paste0(results_folder, results_files)


#Open Data results
open_data_files <- results_files[results_files %>% str_detect("Open_Data")]
open_data_results <- map(open_data_files, read_csv)
open_data_results <- do.call(rbind, open_data_results) %>%
  rename(doi = article) %>%
  distinct(doi, .keep_all = TRUE) %>%
  select(doi, is_open_data, open_data_category,
         is_open_code, open_data_statements, open_code_statements)

#convert dois to standard format
open_data_results$doi <- open_data_results$doi %>%
  str_remove(fixed(".txt")) %>%
  str_replace_all(fixed("+"), fixed("/"))


#manually checked Open Data results
open_data_manual_files <- results_files[results_files %>% str_detect("OD_manual_check_")]
open_data_manual <- open_data_manual_files %>%
                    map(read_csv)
#unify columns
has_in_PURE <- map_lgl(open_data_manual, function(x) "in_PURE" %in% colnames(x))
open_data_manual[has_in_PURE] <- open_data_manual[has_in_PURE] %>%
  map(select, -in_PURE)
#clean results
open_data_manual <- do.call(rbind, open_data_manual) %>%
  mutate(doi = (doi %>% (function(x) x %>%
                           str_remove(fixed(".txt")) %>%
                           str_replace_all(fixed("+"), "/")))) %>%
  distinct(doi, .keep_all = TRUE) %>%
  select(doi, open_data_manual_check, open_data_category_manual,
         open_code_manual_check, open_code_category_manual)


#Barzooka results
barzooka_files <- results_files[results_files %>% str_detect("Barzooka")]
barzooka_results <- map(barzooka_files, read_csv)
barzooka_results <- map(barzooka_results, select,
                        c(paper_id, bar, pie, bardot, box, dot, hist, violin)) %>%
  bind_rows() %>%
  rename(doi = paper_id) %>%
  distinct(doi, .keep_all = TRUE)


#Open Access results
publications <- publications %>%
  rename(OA_color = oa_status) %>%
  mutate(OA_color = OA_color %>% str_replace("Gold", "gold"))
publications$OA_color[publications$OA_color %in% c("Kein Ergebnis", "kein Ergebnis")] <- NA


#----------------------------------------------------------------------------------------
# combine results
#----------------------------------------------------------------------------------------

#check if there are no duplicated dois in the results files (problem for left_join)
length(open_data_results$doi) == length(unique(open_data_results$doi))
length(open_data_manual$doi) == length(unique(open_data_manual$doi))
length(barzooka_results$doi) == length(unique(barzooka_results$doi))


dashboard_metrics <- publications %>%
  left_join(open_data_results, by = "doi") %>%
  left_join(open_data_manual, by = "doi") %>%
  left_join(barzooka_results, by = "doi") %>%
  mutate(pdf_downloaded = !is.na(is_open_data))


#----------------------------------------------------------------------------------------
# further preprocessing needed for manually verified Open Data cases
#----------------------------------------------------------------------------------------

#data plausibility/quality check for the updated PDF dataset -> are there any new
#cases that we missed? For old PDF dataset, there were 0 cases, now again 0 cases
check_tbl <- dashboard_metrics %>%
  filter((is_open_data & is.na(open_data_manual_check)) |
           (is_open_code & is.na(open_code_manual_check))) %>%
  select(doi, year, is_open_data, open_data_category, is_open_code,
         open_data_statements, open_code_statements,
         open_data_manual_check, open_data_category_manual,
         open_code_manual_check, open_code_category_manual)
dim(check_tbl)
#write_csv(check_tbl, "./results/OD_manual_check/pdf_update_cases.csv")


#some of the open data cases were only manually detected
#need to update the is_open_data status for them
od_manual_pos <- (!is.na(dashboard_metrics$open_data_manual_check) &
                    dashboard_metrics$open_data_manual_check == "TRUE")
dashboard_metrics[od_manual_pos,]$is_open_data <- TRUE

no_access_pos <- (!is.na(dashboard_metrics$open_data_manual_check) &
                    dashboard_metrics$open_data_manual_check == "no access")
dashboard_metrics[no_access_pos,]$open_data_manual_check <- "FALSE"

no_od_pos <- (is.na(dashboard_metrics$open_data_manual_check) &
                !is.na(dashboard_metrics$is_open_data))
dashboard_metrics[no_od_pos,]$open_data_manual_check <- "FALSE"

no_check <- (is.na(dashboard_metrics$is_open_data) &
               !is.na(dashboard_metrics$open_data_manual_check))
dashboard_metrics[no_check,]$open_data_manual_check <- NA

#need to do the same cleaning of the manual data for open code
oc_manual_pos <- (!is.na(dashboard_metrics$open_code_manual_check) &
                    dashboard_metrics$open_code_manual_check == TRUE)
dashboard_metrics[oc_manual_pos,]$is_open_code <- TRUE

no_oc_pos <- (is.na(dashboard_metrics$open_code_manual_check) &
                !is.na(dashboard_metrics$is_open_code))
dashboard_metrics[no_oc_pos,]$open_code_manual_check <- FALSE

no_check_oc <- (is.na(dashboard_metrics$is_open_code) &
               !is.na(dashboard_metrics$open_code_manual_check))
dashboard_metrics[no_check_oc,]$open_code_manual_check <- NA


#----------------------------------------------------------------------------------------
# save resulting tabe with relevant columns only
#----------------------------------------------------------------------------------------

#only select columns relevant for shiny table
shiny_table <- dashboard_metrics %>%
  select(doi, pmid, title, journal,
         year, pdf_downloaded, OA_color,
         is_open_data, open_data_manual_check, open_data_category_manual,
         is_open_code, open_code_manual_check, open_code_category_manual,
         open_data_statements, open_code_statements,
         bar, pie, bardot, box, dot, hist, violin)

write_csv(shiny_table, "shiny_app/data/dashboard_metrics.csv")


#----------------------------------------------------------------------------------------
# now for the metrics that are already aggregated by year
#----------------------------------------------------------------------------------------

preprints_dataset_shiny <- read_csv("./results/preprints.csv") %>%
  select(doi, title, journal.title, year)
write_csv(preprints_dataset_shiny, "./shiny_app/data/preprints_dataset_shiny.csv")


preprints <- read_csv("./results/preprints.csv") %>%
  group_by(year) %>%
  summarize(preprints = n())

total_publ_dimensions = read_csv("./results/Charite_publication_ids_dimensions_2006_19.csv") %>%
  group_by(year) %>%
  summarize(total_publ_dimensions = n())

prospective_registration <- read_csv("./results/prospective_registration.csv")
summary_results_12_month <- read_csv("./results/summary_results_12_month.csv")
summary_results_24_month <- read_csv("./results/summary_results_24_month.csv")


shiny_table_aggregate_metrics <- tibble(year = 2006:2020) %>%
  left_join(prospective_registration) %>%
  left_join(summary_results_12_month) %>%
  left_join(summary_results_24_month) %>%
  left_join(total_publ_dimensions) %>%
  left_join(preprints)

write_csv(shiny_table_aggregate_metrics, "shiny_app/data/dashboard_metrics_aggregate.csv")
